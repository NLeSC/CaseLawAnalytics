<!DOCTYPE html>
<html lang="en">
<!-- START SIGMA IMPORTS -->
<script src="lib/sigma/sigma.min.js"></script>
<script src="lib/sigma/plugins/sigma.parsers.json.min.js"></script>
<script src="lib/sigma/plugins/sigma.layout.forceAtlas2.min.js"></script>
<script src="lib/sigma/plugins/sigma.layout.noverlap.min.js"></script>
<script src="lib/sigma/plugins/sigma.plugins.animate.min.js"></script>

<div id="container">
    
    <style>
        #graph-container {
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            position: absolute;
        }
        #input-form {
            position: relative;
        }
    </style>
    <div id="graph-container"></div>
    <div id="attribute-pane"></div>
    <div id="input-form">
        <form enctype="multipart/form-data" method="post">
            <input id="json-file" type="file" onchange="loadData()"/>
        </form>
    </div>
</div>
    

<script>
    var g = {
        nodes: [],
        edges: []
    };

    // Create new Sigma instance in graph-container div (use your div name here)
    s = new sigma({
        graph: g,
        container: 'graph-container',
        renderer: {
            container: document.getElementById('graph-container'),
            type: 'canvas'
        },
        drawingProperties : {
            //defaultEdgeArrow : 'source',
            //defaultEdgeType: "arrow",
            defaultEdgeColor: '#000',
        },
        settings: {
            minNodeSize: 3,
            minArrowSize: 7,
//            minEdgeSize: 5,
            //nodesPowRatio: 1
            //autoRescale: false
         //   maxNodeSize: 16
        }
    });
    forceConfig = {
        gravity: 1,
        linLogMode: true
    }

    var listener = s.configNoverlap({
        nodeMargin: 5.0,
        scaleNodes: 1.3,
        easing: 'quadraticInOut', // animation transition function
        duration: 1000
    });

    listener.bind('start stop interpolate', function(event) {
        console.log(event.type);
    });

    var make_node_title = function(node){
        var label = node.title == "" ? node.id : node.title;
        var articles = Object.keys(node.articles).join(", ");
        if(articles.length>0){
            label = label + " -- " + articles;
        }
        return label;
    };
    
    var onLoad = function(){
        // this below adds x, y attributes as well as size = degree of the node
            var i,
                nodes = s.graph.nodes(),
                len_n = nodes.length;

            for (i = 0; i < len_n; i++) {
                nodes[i].x = Math.random();
                nodes[i].y = Math.random();
                nodes[i].size = 2*s.graph.degree(nodes[i].id);
                //nodes[i].label = nodes[i].title == "" ? nodes[i].id : nodes[i].title;
                nodes[i].label = make_node_title(nodes[i]);
                nodes[i].color = '#000';
            }
            s.graph.edges().forEach(function(edge){
                edge.type = "arrow";
                edge.color = '#999';
            });
            s.refresh();

            // ForceAtlas Layout
            s.startForceAtlas2(forceConfig);
            setTimeout(function(){
                s.stopForceAtlas2();
                s.startNoverlap();}, 10000)
    }
    
    sigma.parsers.json(
        'network_sigma.json',
        s,
        onLoad
    );
    
    var onNewDataEvent = function(e) {
        var filetxt = e.target.result;
        var newdata = JSON.parse(filetxt);
        s.graph.clear();
        s.graph.read(newdata);

        onLoad();
        s.refresh();
    };
    
    //document.getElementById('json-file').addEventListener('change', loadData, false);
    
    var loadData = function(){
        console.log('Loading data...');
        if(document.getElementById("json-file")) {
            var jsonfile = document.getElementById("json-file").files[0];
            var fileReader = new FileReader();
            fileReader.onload = onNewDataEvent;
            fileReader.readAsText(jsonfile);


        }
    };

    s.bind('clickNode doubleClickNode rightClickNode', function(e) {
        console.log(e.data);
        window.open(e.data.node.id);
    });

    s.bind('clickNode doubleClickNode rightClickNode', function(e) {
        window.open(e.data.node.id);
    });

    s.bind('overNode', function(e) {
        console.log(e.data.node);
    })



</script>